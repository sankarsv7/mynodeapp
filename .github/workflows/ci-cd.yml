- name: Update Kubernetes manifests with new image
  env:
    IMAGE_URI: ${{ env.IMAGE_URI }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    echo "Updating deployment image to: $IMAGE_URI"

    # Update image in deployment.yaml
    sed -i "s|image: .*|image: $IMAGE_URI|g" k8s/deployment.yaml

    git config user.name "github-actions"
    git config user.email "actions@github.com"

    # authenticate git push
    git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}

    # fetch latest to avoid "fetch first" error
    git fetch origin main
    git pull origin main --rebase || true

    git add k8s/deployment.yaml
    git commit -m "ci: update image to $IMAGE_URI" || echo "No changes"

    git push origin HEAD:main
